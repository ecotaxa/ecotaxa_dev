{#<span id="taxoclearspan">{{ g.taxoclearspan|safe }}</span>#}
  <div style="width: 230px;">
    <div class="input-group">
       <select id="taxolbanno" name="taxolbanno" style="width: 170px" class='taxolb'  autocomplete="off"> </select>
            <span class="input-group-btn">
                <button class="btn btn-default btn-sm" type="button"  data-toggle="modal" data-target="#TaxoModal" data-mytargetid="taxolbanno" title="Search on Taxonomy Tree">
                    <span id=OpenTaxoLB class="glyphicon glyphicon-th-list" aria-hidden="true"/></button>
                </span>
            <span class="input-group-btn">
                <button class="btn btn-default btn-sm" type="button" title="or Ctrl+A to assign to selection" onclick="AssignTaxoLbToSelection();">
                    <span id=AssignTaxo class="glyphicon glyphicon-tags" aria-hidden="true"/></button>
                </span>



        </div><!-- /input-group -->
  </div>

  <div id='divclassiftab' style="width: 255px;overflow-y:auto;">
<table class="classiftab" width="98%">
{% for v in res %}
<tr><td taxoid="{{ v['id'] }}" class="{{  v['parentclasses'] }}">
        <b>{{ ("&#8226;"*v['dist'] if v['dist']>0 else "" ) |safe }}</b>
        {% if v['haschild'] %}<span class="glyphicon glyphicon-triangle-bottom categexpander" ></span>{% endif %}
    <span class="taxodrop">{{ v['taxoname'] }}</span> <p  class="ra3 label {{ "label-info" if v['nbrnotv']>0 else "label-success"}}">{{ v['nbr'] }}{{ " ("~v['nbrnotv']~")" if v['nbrnotv']>0 }}</p></td></tr>
{% endfor %}
</table>
  </div>

  <script>
  function SetTaxoFilter(taxofiltervalue,taxofilterlabel){
      //debugger;
      if(taxofiltervalue==false){
          $("#taxofilter").val("");
          $('#taxoclearspan').html("");
          $("#taxofilterlabel").val("");
          if(taxofilterlabel==-1) LoadRightPane();
          return;
      }
      $("#taxofilter").val(taxofiltervalue);
      $("#taxofilterlabel").val(taxofilterlabel);
      $('#taxoclearspan').html('<span class="label label-default" onclick="SetTaxoFilter(false,-1)">Clear '+taxofilterlabel+'</span>')
  }
function CategExpanderClick(e){
    e.stopPropagation();
    e.preventDefault();
    if($(this).hasClass("glyphicon-triangle-bottom")){
        $(this).removeClass("glyphicon-triangle-bottom").addClass("glyphicon-triangle-right");
        $('#divclassiftab .visib'+$(this).closest("td").attr("taxoid")).hide();
    }
    else {
        $(this).removeClass("glyphicon-triangle-right").addClass("glyphicon-triangle-bottom");
        $('#divclassiftab .visib'+$(this).closest("td").attr("taxoid")).show();

    }

}

{% if g.PrjAnnotate %}
    {# Traitement de la Liste des objets TD à traiter. #}
    function ProcessList(LstTd,droptaxoid,droptaxoname) {
        var TrSet = new Set();
        PendingChangesTaxoName[droptaxoid]=droptaxoname;
        // Traitement des cellules
          for(var i= 0; i < LstTd.length; i++) {
              var td=LstTd[i];
              td.removeClass("ui-selected");
              td.addClass("ToBeSaved")
              var id = td.find('img').attr('id');
              td.find('.taxo').text(droptaxoname);
              td.find('.subimg').css("height",'').css("width",'').css("left",'').css("top",'').css("right",'').css("bottom",'');
              td.find('.subimg').attr('class','subimg status-validated');
              TrSet.add(td.closest('tr').attr('id'));
              PendingChanges[id.substr(1)]=droptaxoid;
              //td.css('background-color', '#80FF80')
              //console.log(o, id ,droptaxoid,droptaxoname);
          }
          NbrChanged=LstTd.length;
          // Ces resizes ralentissent mais permettent de recaller les zoom tracker suite au changement de taille des taille de taxo
          // sur table 1000 image à 10% ligne 42 ca Freeze 4s
          // sur table 200 images à 10% ca Freeze 1s
          // Sur 50&100 ca ne se voit pas
          //for ( trid of TrSet) Marche pas sous IE
          TRArray=Array.from(TrSet)
          for(var i= 0; i < TRArray.length; i++)
          {
              var trid=TRArray[i];
              $('#' + trid).find('td img').resize();
              //console.log("resize #"+trid);
          }
        var calctotaux={}
        for (var k in PendingChanges) {
            v=0;
            if (PendingChanges[k] in calctotaux) v=calctotaux[PendingChanges[k]];
            calctotaux[PendingChanges[k]]=v+1;
        }
        var Msg="Pending Changes : ";
        PendingChangesTaxoName[-1]="Unchanged";
        for (var k in calctotaux)
            Msg=Msg+calctotaux[k]+" "+PendingChangesTaxoName[k]+", ";
        $('.PendingChangesClass').text(Msg);

    }
function SavePendingChanges(NextPage) {
    {#  console.log("prev",PendingChanges); #}
    req={changes:PendingChanges,qual:'V'}
    $(".PendingChangesClass").html('<span class="label label-info">Server update in progress...</span>');
    $("#PendingChanges").load("/prj/ManualClassif/"+$("#projid").val(),req,function(){
        $("#PendingChanges2").html($("#PendingChanges").html());
        if ($("#PendingChanges").html().indexOf("Successfull")>0) {
            PendingChanges={}; // After successfull update no pending changes.
            if(NextPage==1)
               $("#pageoffset").val(parseInt($("#pageoffset").val())+1);
            LoadRightPane();
        }
    });
}
function ValidateAll(NextPage) {
    {# On valide tout ce qui est predicted ou validated et qui n'est pas déjà en attente de save #}
    $(".status-validated,.status-predicted").parents('td').find('img.lazy').each(function (e,o) {
        //console.log($(o).attr("id").substr(1));
        if(PendingChanges[$(o).attr("id").substr(1)]===undefined)
            PendingChanges[$(o).attr("id").substr(1)]=-1; {# Set unchanged but validate #}
    });
    SavePendingChanges(NextPage);
}

{% endif %}
  $(function() {
    $( ".classiftab td"
{% if g.PrjAnnotate %}
    ).droppable({
      tolerance: "pointer",
      hoverClass: "taxodrop_hover",
      drop: function( event, ui ) {
          //console.log(ui.draggable);
          //console.log(this);
          var droptaxoid=$(this).attr('taxoid');
          var droptaxoname=$(this).find(".taxodrop").text();

         $('#taxolbanno').append($('<option>', {    value: droptaxoid,    text: droptaxoname}));
          var sel=[];
          sel.push(droptaxoid);
          $('#taxolbanno').val(sel);
          $('#taxolbanno').change();


          var NbrChanged=0;
          var  LstTd=[];
          ui.draggable.each(function (e,o) {
              if( $(o).hasClass( "zoomtracker" )) {
                  LstTd.push(  $($(o).data("specs").origImg.closest('td')));
{#              } else if( $(o).hasClass( "taxo" )) {  // Sinon c'est le taxo du div subimg#}
              } else if( $(o).is( "td" )) {  // Sinon c'est le taxo du div subimg
                  LstTd.push(  $(o));
              } else if( $(o).hasClass( "lazy" )) {  // Sinon c'est l'image
                  LstTd.push(  $(o).closest('td'));
              }
              //Si c'est un item selected, on le supprime car va être ajouté par
              if(LstTd.length>0)
                if(LstTd[0].hasClass( "ui-selected" ))
                    LstTd.pop();
              // On ajoute tout ceux qui sont selectionnés.
              $(".ui-selected").each(function(){LstTd.push($(this));});
          });
        ProcessList(LstTd,droptaxoid,droptaxoname);
        // Highlight only the last
        $( "#TabA .ui-state-highlight").removeClass( "ui-state-highlight");
        var n=  parseInt($( this ).find( "p").text())||0;
        $( this ).addClass( "ui-state-highlight" ).find( "p" ).html(n+NbrChanged );
      }
    }
{% endif %}
    ).click(function() {
                //$("#taxofilter").val($(this).attr('taxoid'));
                $(".ui-state-highlight").removeClass("ui-state-highlight");
                if ($(this).hasClass('activeTaxo'))
                    SetTaxoFilter(false, -1);
                else {
                SetTaxoFilter($(this).attr('taxoid'), $(this).find('.taxodrop').text());
                LoadRightPane();
            }
    });

  });
  </script>


{% if g.PrjAnnotate %}
<script>
function AssignTaxoLbToSelection() {
    droptaxoid = $('#taxolbanno').val();
    if (droptaxoid) {
        var LstTd = [];
        $(".ui-selected").each(function () {
            LstTd.push($(this));
        });
        ProcessList(LstTd, droptaxoid, $('#taxolbanno  option:selected').text());
    }
}

$(document).ready(function() {
    EnableSelect2Taxolb();
{#    Le fait de choisir un item fait l'assignation/CTRL+A#}
    $('#taxolbanno').on("select2:select", function (e) {
        AssignTaxoLbToSelection();
        $(".ui-state-highlight").removeClass("ui-state-highlight");
    });
{#     Ctrl + A affecte la valeur selectionnée#}
{#    $('#taxolbanno').closest('.input-group').find('.select2-selection--single').bind('keydown', 'Test1', function(e) {#}
    $(document).bind('keydown', 'Test1', function(e) {
       if((e.keyCode === 65)&& (e.ctrlKey||e.metaKey)) { {# CTRL+A #}
          AssignTaxoLbToSelection();
          e.preventDefault();
      }
       if((e.keyCode === 83)&& (e.ctrlKey||e.metaKey)) { {# CTRL+S #}
          SavePendingChanges();
          e.preventDefault();
      }

    });
{#  Si pression sur une touche alors que le focus n'est sur aucun input (donc dans body), on ouvle la popup#}
    $(document).bind('keydown', function(e) {
      if((document.activeElement.nodeName=='BODY')||(document.activeElement.nodeName=='SPAN'))
       if((e.keyCode >= 65)&&(e.keyCode <= 90)&& !e.ctrlKey&& !e.metaKey)
         if($(".ui-selected").length>0)
       {
         $('#taxolbanno').select2("open");
         $('.taxopopup .select2-search__field').val(String.fromCharCode(e.keyCode));
          //console.log(e);
          e.preventDefault();
      }
    });

{#  Initialisation Context Menu  #}
    $.contextMenu({
    // define which elements trigger this menu
    selector: ".classiftab td",
    // define the elements of the menu
    build: function($trigger, e) {
        res= {
            callback: function (key, options) {
                var taxoid=parseInt(key.substr(1));
                var taxoname=taxotree[taxoid][1];
                $('#taxolbanno').append($('<option>', { value: taxoid,text: taxoname}));
                var sel=[];
                sel.push(taxoid);
                $('#taxolbanno').val(sel);
                $('#taxolbanno').change();
                AssignTaxoLbToSelection();
            },
            items: {}
        };
         var taxoid=$(e.currentTarget).attr('taxoid');
         var taxoname=$(e.currentTarget).find(".taxodrop").text();
        var Arr=[]
         //res["items"]["o"+taxoid]={name:taxoname}
        Arr.unshift({key:"o"+taxoid,name:taxoname})
        for(var i=0;i<50;i++) {
            taxoid=taxotree[taxoid][2]; // Go to parent
            if (taxoid==null) break;
            taxoname=taxotree[taxoid][1];
            //res["items"]["o"+taxoid]={name:taxoname};
            //res["items"].unshift("o"+taxoid])={name:taxoname};
            Arr.unshift({key:"o"+taxoid,name:taxoname})
        }
        for	(index = 0; index < Arr.length; index++)
            res["items"][Arr[index]["key"]]={name:Arr[index]["name"]}

        console.log(res["items"]);
        return res;
    }
});

    $("#divclassiftab").outerHeight( $("#column-left").innerHeight()-$("#divclassiftab").position().top );
    $("#divclassiftab .categexpander").click(CategExpanderClick).hover(function(e){
        if((DragInProgress)&&($(this).hasClass("glyphicon-triangle-right"))) {
            {# Quand on passe sur un triange fermé sur un Drag&Drop on simule un clic sur le triangle pour l'ouvrir #}
            $(this).click();

        }
    });

}); // Ready


var taxotree={{ taxotree|safe }};

</script>
{% endif %}